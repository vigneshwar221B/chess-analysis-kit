name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - "infrastructure/**"
      - "**.md"
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: chess-analysis-kit-eks

jobs:
  # ── Build images and deploy frontend to S3 ──────────
  build-and-push:
    name: Build & Push
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate image tag
        id: tag
        run: echo "tag=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Read config from SSM
        id: config
        run: |
          BACKEND_REPO=$(aws ssm get-parameter --name /chess-app/ecr-backend-repo --query 'Parameter.Value' --output text)
          BACKEND_URL=$(aws ssm get-parameter --name /chess-app/backend-url --query 'Parameter.Value' --output text)
          FRONTEND_BUCKET=$(aws ssm get-parameter --name /chess-app/frontend-bucket --query 'Parameter.Value' --output text 2>/dev/null || echo "")
          CLOUDFRONT_ID=$(aws ssm get-parameter --name /chess-app/cloudfront-distribution-id --query 'Parameter.Value' --output text 2>/dev/null || echo "")
          echo "backend-repo=${BACKEND_REPO}" >> "$GITHUB_OUTPUT"
          echo "backend-url=${BACKEND_URL}" >> "$GITHUB_OUTPUT"
          echo "frontend-bucket=${FRONTEND_BUCKET}" >> "$GITHUB_OUTPUT"
          echo "cloudfront-id=${CLOUDFRONT_ID}" >> "$GITHUB_OUTPUT"

      - name: Build and push backend image
        run: |
          docker build -t ${{ steps.config.outputs.backend-repo }}:${{ steps.tag.outputs.tag }} ./backend
          docker push ${{ steps.config.outputs.backend-repo }}:${{ steps.tag.outputs.tag }}

      - name: Build frontend static assets
        run: |
          cd frontend
          npm ci
          VITE_BACKEND_URL=http://${{ steps.config.outputs.backend-url }} npm run build

      - name: Deploy frontend to S3
        if: steps.config.outputs.frontend-bucket != ''
        run: |
          aws s3 sync frontend/dist/ s3://${{ steps.config.outputs.frontend-bucket }}/ --delete

      - name: Invalidate CloudFront cache
        if: steps.config.outputs.cloudfront-id != ''
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.config.outputs.cloudfront-id }} \
            --paths "/*"

  # ── Update Helm values → triggers ArgoCD sync ──────
  update-helm:
    name: Update Helm Values
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR repo URL
        id: config
        run: |
          BACKEND_REPO=$(aws ssm get-parameter --name /chess-app/ecr-backend-repo --query 'Parameter.Value' --output text)
          echo "backend-repo=${BACKEND_REPO}" >> "$GITHUB_OUTPUT"

      - name: Update backend image tag in values.yaml
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          BACKEND_REPO: ${{ steps.config.outputs.backend-repo }}
        run: |
          cd k8s/chess-app-helm-chart
          # Update image and tag under backend section
          yq -i '.backend.image = strenv(BACKEND_REPO)' values.yaml
          yq -i '.backend.tag = strenv(IMAGE_TAG)' values.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/chess-app-helm-chart/values.yaml
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "ci: update backend image to ${{ needs.build-and-push.outputs.image-tag }}"
          git push

  # ── Verify the deployment landed ───────────────────
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: update-helm

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Wait for ArgoCD sync
        run: |
          echo "Waiting 60s for ArgoCD to detect and sync..."
          sleep 60

      - name: Verify backend rollout
        run: |
          kubectl rollout status deployment/chess-backend --timeout=5m
          kubectl get pods -l app=chess-backend

      - name: Health check
        run: |
          BACKEND_URL=$(aws ssm get-parameter --name /chess-app/backend-url --query 'Parameter.Value' --output text)
          curl -f "http://${BACKEND_URL}/health" || exit 1
          echo "Health check passed"
